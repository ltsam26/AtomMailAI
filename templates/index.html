<!DOCTYPE html>
<html>
<head>
    <title>Atom Mail AI</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; display: flex; }
        .sidebar { width: 30%; padding: 20px; background: #f9f9f9; border-right: 1px solid #ddd; }
        .main { width: 70%; padding: 20px; }
        textarea { width: 100%; height: 120px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; }
        .history .email { border-bottom: 1px solid #eee; padding: 10px; white-space: pre-wrap; font-size: 14px; }
        #suggestion { color: #666; margin: 10px 0; font-style: italic; }
        #loading { display: none; color: #007bff; font-style: italic; }
        button { padding: 8px 16px; margin-right: 10px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        select, input { padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Inbox (History)</h2>
        <div class="history">
            {% if history %}
                {% for email in history %}
                    <div class="email">{{ email | safe }}</div>
                {% endfor %}
            {% else %}
                <p>No emails yet.</p>
            {% endif %}
        </div>
    </div>
    <div class="main">
        <h1>Atom Mail AI</h1>
        <form method="post">
            <textarea name="input_text" id="input-text" placeholder="Type your prompt or email here..." oninput="getSuggestion()"></textarea>
            <div id="suggestion"></div>
            <div id="loading">Generating...</div>
            <select name="template">
                <option value="">Select Template</option>
                {% for key in templates %}
                    <option value="{{ key }}">{{ key.capitalize() }}</option>
                {% endfor %}
            </select>
            <button type="submit" name="action" value="compose">Compose</button>
            <button type="submit" name="action" value="reply">Reply</button>
            <button type="submit" name="action" value="refine" onclick="toggleRefineOptions(true)">Refine</button>
            <div id="refine-options" style="display: none;">
                <select name="refine_action">
                    <option value="shorten">Shorten</option>
                    <option value="improve">Improve</option>
                    <option value="formalize">Formalize</option>
                    <option value="casual">Casual</option>
                </select>
            </div>
            <button type="submit" name="action" value="clear_history">Clear History</button>
            <h3>Preferences</h3>
            <label>Tone: <input name="default_tone" value="{{ prefs.default_tone }}"></label>
            <label>Recipient: <input name="default_recipient" value="{{ prefs.default_recipient }}"></label>
            <label>Signature: <input name="signature" value="{{ prefs.signature }}"></label>
            <label>Phrase: <input name="phrase" value="{{ prefs.preferred_phrases[0] }}"></label>
            <button type="submit" name="action" value="save_prefs">Save Preferences</button>
            <h3>Feedback</h3>
            <label>Rating: <input name="rating" type="number" min="1" max="5"></label>
            <button type="submit" name="action" value="feedback">Submit Feedback</button>
        </form>
        <h2>Output</h2>
        <pre>{{ output }}</pre>
    </div>
    <script>
        function toggleRefineOptions(show) {
            document.getElementById("refine-options").style.display = show ? "block" : "none";
        }
        let debounceTimeout;
        function getSuggestion() {
            document.getElementById("loading").style.display = "block";
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const text = document.getElementById("input-text").value;
                const suggestionDiv = document.getElementById("suggestion");
                if (text.length > 3) {
                    console.log("Fetching suggestion for:", text);
                    fetch("/suggest", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ text: text })
                    })
                    .then(response => response.json())
                    .then(data => {
                        suggestionDiv.innerText = "Suggestion: " + data.suggestion;
                        document.getElementById("loading").style.display = "none";
                    })
                    .catch(error => {
                        console.error("Suggestion error:", error);
                        suggestionDiv.innerText = "Error fetching suggestion";
                        document.getElementById("loading").style.display = "none";
                    });
                } else {
                    suggestionDiv.innerText = "";
                    document.getElementById("loading").style.display = "none";
                }
            }, 1500);
        }
    </script>
</body>
</html>