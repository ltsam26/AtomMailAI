<!DOCTYPE html>
<html data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Atom Mail AI</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <!-- Styles -->
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
    <!-- Topbar -->
    <div class="topbar">
        <h1>Atom Mail AI</h1>
        <button id="theme-toggle">
            <span class="material-icons">light_mode</span>
            <span class="toggle-text">Switch to Dark Theme</span>
        </button>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
        <span class="material-icons">search</span>
        <input type="text" placeholder="Search mail" />
    </div>

    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <button class="compose-button">
                <span class="material-icons">edit</span> Compose
            </button>

            <nav>
                <ul>
                    <li class="active"><span class="material-icons">inbox</span> Inbox (History)</li>
                    <li><span class="material-icons">send</span> Sent</li>
                    <li><span class="material-icons">drafts</span> Drafts</li>
                    <li><span class="material-icons">star</span> Starred</li>
                    <li><span class="material-icons">delete</span> Trash</li>
                </ul>
            </nav>

            <!-- History -->
            <div class="history">
                <h3>History</h3>
                {% if history %}
                    {% for email in history %}
                        <div class="email">{{ email | safe }}</div>
                    {% endfor %}
                {% else %}
                    <p>No emails yet.</p>
                {% endif %}
            </div>

            <!-- Preferences -->
            <div class="preferences">
                <h3>Preferences</h3>
                <form method="POST">
                    <input type="hidden" name="action" value="save_prefs" />
                    <label>Default Tone:</label>
                    <select name="default_tone">
                        <option value="professional" {% if prefs.default_tone == "professional" %}selected{% endif %}>Professional</option>
                        <option value="formal" {% if prefs.default_tone == "formal" %}selected{% endif %}>Formal</option>
                        <option value="casual" {% if prefs.default_tone == "casual" %}selected{% endif %}>Casual</option>
                        <option value="friendly" {% if prefs.default_tone == "friendly" %}selected{% endif %}>Friendly</option>
                    </select>
                    <label>Default Recipient:</label>
                    <input type="text" name="default_recipient" value="{{ prefs.default_recipient }}" />
                    <label>Signature:</label>
                    <input type="text" name="signature" value="{{ prefs.signature }}" />
                    <label>Phrase:</label>
                    <input type="text" name="phrase" value="{{ prefs.preferred_phrases[0] }}" />
                    <input type="submit" value="Save" />
                </form>
            </div>

            <!-- Clear History -->
            <form method="POST" style="margin-top: 10px;">
                <input type="hidden" name="action" value="clear_history" />
                <input type="submit" value="Clear History" />
            </form>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <form method="POST" id="email-form">
                <textarea name="input_text" id="input-text" placeholder="Type your prompt or email here..." onkeyup="getSuggestion()"></textarea>
                <div id="suggestion"></div>
                <div id="loading" style="display: none;">Generating...</div>

                <!-- Action Selection -->
                <div class="options">
                    <label><input type="radio" name="action" value="compose" checked onclick="toggleRefineOptions(false)"> Compose</label>
                    <label><input type="radio" name="action" value="reply" onclick="toggleRefineOptions(false)"> Reply</label>
                    <label><input type="radio" name="action" value="refine" onclick="toggleRefineOptions(true)"> Refine</label>
                </div>

                <label>Template:</label>
                <select name="template">
                    <option value="">None</option>
                    {% for key in templates %}
                        <option value="{{ key }}">{{ key|capitalize }}</option>
                    {% endfor %}
                </select>

                <!-- Refinement Options -->
                <div class="refine-options" id="refine-options" style="display:none;">
                    <label>Refinement:</label>
                    <select name="refine_action">
                        <option value="shorten">Shorten</option>
                        <option value="improve">Improve</option>
                        <option value="formalize">Formalize</option>
                        <option value="casual">Casual</option>
                        <option value="professional">Professional</option>
                        <option value="friendly">Friendly</option>
                    </select>
                </div>

                <input type="submit" value="Submit" />
            </form>

            <!-- Output Section -->
            <section class="output-section">
                <h2>Generated Email</h2>
                <pre id="output">{{ output }}</pre>

                <form method="POST" class="feedback-form">
                    <input type="hidden" name="action" value="feedback" />
                    <label>Rate:</label>
                    <select name="rating">
                        <option value="1">1 (Poor)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 (Great)</option>
                    </select>
                    <input type="submit" value="Submit Feedback" />
                </form>
            </section>
        </main>
    </div>

    <!-- Script -->
    <script>
        function toggleRefineOptions(show) {
            document.getElementById("refine-options").style.display = show ? "block" : "none";
        }

        let debounceTimeout;
        function getSuggestion() {
            document.getElementById("loading").style.display = "block";
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const text = document.getElementById("input-text").value;
                const suggestionDiv = document.getElementById("suggestion");
                if (text.length > 3) {
                    console.log("Fetching suggestion for:", text);
                    fetch("/suggest", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ text: text })
                    })
                    .then(response => response.json())
                    .then(data => {
                        suggestionDiv.innerText = "Suggestion: " + data.suggestion;
                        document.getElementById("loading").style.display = "none";
                    })
                    .catch(error => {
                        console.error("Suggestion error:", error);
                        suggestionDiv.innerText = "Error fetching suggestion";
                        document.getElementById("loading").style.display = "none";
                    });
                } else {
                    suggestionDiv.innerText = "";
                    document.getElementById("loading").style.display = "none";
                }
            }, 1500);
        }

        // Theme toggle functionality
        const toggleButton = document.getElementById("theme-toggle");
        const icon = toggleButton.querySelector(".material-icons");
        const text = toggleButton.querySelector(".toggle-text");

        toggleButton.addEventListener("click", () => {
            const html = document.documentElement;
            const currentTheme = html.getAttribute("data-theme");
            if (currentTheme === "dark") {
                html.setAttribute("data-theme", "light");
                icon.textContent = "light_mode";
                text.textContent = "Switch to Dark Theme";
            } else {
                html.setAttribute("data-theme", "dark");
                icon.textContent = "dark_mode";
                text.textContent = "Switch to Light Theme";
            }
        });
    </script>
</body>
</html>